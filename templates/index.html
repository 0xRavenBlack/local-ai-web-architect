<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local AI Web Agent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: #16213e; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h1 { color: #4cc9f0; margin-top: 0; }
        h2 { color: #f72585; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top:0; }
        
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #333; background: #0f3460; color: #fff; margin-bottom: 15px; box-sizing: border-box; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        button { background: #4361ee; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #3a0ca3; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        .btn-save { background: #4cc9f0; color: #000; width: 100%; }
        .btn-gen { background: #f72585; font-size: 1.1rem; width: 100%; margin-top: 10px; }
        .btn-download { background: #06d6a0; color: #000; width: 100%; font-size: 1.1rem; margin-top: 10px; display: none; }
        .btn-download:hover { background: #05b889; }

        #terminal { background: #000; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; color: #0f0; white-space: pre-wrap; }
        .progress-bar { width: 100%; height: 6px; background: #333; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4cc9f0; width: 0%; transition: width 0.3s; }
        
        .hint { font-size: 0.8rem; color: #666; margin-top: -10px; margin-bottom: 10px; }
        
        .result-section { display: none; }
        .result-section.show { display: block; }
        
        .result-links { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .result-card { background: #0f3460; padding: 15px; border-radius: 5px; text-align: center; }
        .result-card a { color: #4cc9f0; text-decoration: none; font-weight: bold; }
        .result-card a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1><i class="fas fa-robot"></i> AI Web Agent System</h1>
        </div>

        <!-- Configuration Section -->
        <div class="card">
            <h2><i class="fas fa-cog"></i> Model Configuration</h2>
            
            <label>Ollama Model Name</label>
            <input type="text" id="ollama_model" placeholder="llama3" value="{{ config.ollama_model }}">

            <label>SDXL Model (in /models folder)</label>
            <select id="sdxl_path">
                <option value="">-- Select Safetensor --</option>
                {% for model in config.available_models %}
                    <option value="models/{{ model }}" {% if model in config.sdxl_path %}selected{% endif %}>{{ model }}</option>
                {% endfor %}
            </select>
            
            <button class="btn-save" onclick="saveConfig()"><i class="fas fa-save"></i> Save All Settings</button>
            <span id="save-msg" style="display:none; color:#4cc9f0; text-align:center; display:block; margin-top:5px;">Saved to .env</span>
        </div>

        <!-- SDXL Quality Settings -->
        <div class="card">
            <h2><i class="fas fa-sliders-h"></i> SDXL Generation Defaults</h2>
            <p class="hint">The Web Designer Agent decides Size and Seed. You define the Quality here.</p>
            
            <div class="grid-3">
                <div>
                    <label>Sampler</label>
                    <select id="sampler">
                        <option value="Euler a" {% if config.sampler == "Euler a" %}selected{% endif %}>Euler a</option>
                        <option value="DPM++ 2M" {% if config.sampler == "DPM++ 2M" %}selected{% endif %}>DPM++ 2M</option>
                        <option value="Euler" {% if config.sampler == "Euler" %}selected{% endif %}>Euler</option>
                        <option value="DDIM" {% if config.sampler == "DDIM" %}selected{% endif %}>DDIM</option>
                    </select>
                </div>
                <div>
                    <label>Steps</label>
                    <input type="number" id="steps" value="{{ config.steps }}">
                </div>
                <div>
                    <label>CFG Scale</label>
                    <input type="number" id="cfg" step="0.5" value="{{ config.cfg }}">
                </div>
            </div>
        </div>

        <!-- Generation Section -->
        <div class="card">
            <h2><i class="fas fa-magic"></i> Generate Website</h2>
            <label>Enter Website Idea</label>
            <input type="text" id="idea" placeholder="A futuristic vertical farming startup">
            <button id="btn-generate" class="btn-gen" onclick="startGeneration()"><i class="fas fa-bolt"></i> Start Agent System</button>
            <button id="btn-download" class="btn-download" onclick="downloadZip()"><i class="fas fa-download"></i> Download Website (ZIP)</button>
            <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        </div>

        <!-- Results Section (Shows after completion) -->
        <div id="result-section" class="card result-section">
            <h2><i class="fas fa-check-circle"></i> Generation Complete!</h2>
            <div class="result-links">
                <div class="result-card">
                    <i class="fas fa-file-code" style="color:#4cc9f0; font-size:2rem; margin-bottom:10px;"></i>
                    <br>
                    <a href="/output/index.html" target="_blank">Open in Browser</a>
                </div>
                <div class="result-card">
                    <i class="fas fa-download" style="color:#06d6a0; font-size:2rem; margin-bottom:10px;"></i>
                    <br>
                    <a href="#" onclick="downloadZip(); return false;">Download ZIP</a>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="card">
            <h2><i class="fas fa-terminal"></i> Agent Activity</h2>
            <div id="terminal">Waiting for input...</div>
        </div>
    </div>

    <script>
        async function saveConfig() {
            const payload = {
                ollama_model: document.getElementById('ollama_model').value,
                sdxl_path: document.getElementById('sdxl_path').value,
                sampler: document.getElementById('sampler').value,
                steps: document.getElementById('steps').value,
                cfg: document.getElementById('cfg').value
            };
            
            const res = await fetch('/api/save_config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            const msg = document.getElementById('save-msg');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 2000);
        }

        async function startGeneration() {
            const idea = document.getElementById('idea').value;
            if(!idea) return alert("Please enter an idea");

            // Reset UI
            document.getElementById('btn-generate').disabled = true;
            document.getElementById('btn-download').style.display = 'none';
            document.getElementById('result-section').classList.remove('show');
            document.getElementById('terminal').innerText = "Initializing agents...\n";
            document.getElementById('progress-fill').style.width = '0%';

            await fetch('/api/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({idea: idea})
            });

            pollStatus();
        }

        async function downloadZip() {
            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!response.ok) throw new Error('Download failed');
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'website.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Download error: ' + error.message);
            }
        }

        // Helper to colorize logs
        function formatLog(logLine) {
            return logLine
                .replace(/\[AGENT\]/g, '<span style="color:#4cc9f0; font-weight:bold;">[AGENT]</span>')
                .replace(/\[SYSTEM\]/g, '<span style="color:#f72585; font-weight:bold;">[SYSTEM]</span>')
                .replace(/\[SDXL\]/g, '<span style="color:#7209b7; font-weight:bold;">[SDXL]</span>')
                .replace(/\[DEBUG\]/g, '<span style="color:#888;">[DEBUG]</span>')
                .replace(/\[ERROR\]/g, '<span style="color:#ff0000; font-weight:bold;">[ERROR]</span>')
                .replace(/\[INFO\]/g, '<span style="color:#0f0;">[INFO]</span>');
        }

        async function pollStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            
            const terminal = document.getElementById('terminal');
            
            // Map logs to HTML with colors
            let logHtml = data.logs.map(line => formatLog(line)).join('<br>');
            terminal.innerHTML = logHtml;
            
            // Auto-scroll to bottom
            terminal.scrollTop = terminal.scrollHeight;
            
            document.getElementById('progress-fill').style.width = data.progress + '%';

            if(data.status === 'running') {
                setTimeout(pollStatus, 500);
            } else {
                document.getElementById('btn-generate').disabled = false;
                
                if(data.status === 'completed') {
                    terminal.innerHTML += "<br><span style='color:#0f0; font-weight:bold;'><br>✅ Done!</span>";
                    
                    // Show download button and results section
                    document.getElementById('btn-download').style.display = 'block';
                    document.getElementById('result-section').classList.add('show');
                } else if(data.status === 'error') {
                    terminal.innerHTML += "<br><span style='color:#f00; font-weight:bold;'><br>❌ Error occurred. Check logs above.</span>";
                }
            }
        }
    </script>
</body>
</html>
